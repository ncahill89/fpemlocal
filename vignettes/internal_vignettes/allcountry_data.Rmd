---
title: "all country results in a single data file"
author: "Gregory Guranich"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{all country}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(FPEMcountry)
library(ggplot2)
library(grid)
library(gridExtra)
```

# Set output directory and aven_data for the set of results
```{r}
# outputdir <- "output_upto2013"
# filenamecreated <- "results_upto2013.csv"
aven_data <- readr::read_csv("C:/Users/desktop-g/Downloads/Track20Database033020.csv") # read in data
divs <- aven_data %>% dplyr::pull(division_numeric_code) %>% unique() %>% as.list() # make a list of division codes from your data
```


## <a name="run"></a>
## run models
```{r}
# map divs to the fit function
fit_list <- purrr::pmap(
  list(
    division_numeric_code = divs,
    surveydata_filepath = "C:/Users/desktop-g/Downloads/Track20Database033020.csv",
    is_in_union = "ALL",
    first_year = 1970,
    last_year = 2030
  ),
  fit_fp_c # the fit function we are mapping too 
)
```
```{r}
results_list <- purrr::pmap(
  fit_list,
  calc_fp_c
)
```


```{r}
allreslist <- list()
for (div in aven_data) {
  reslist <- readRDS(file.path(outputdir, paste0("reslist", div, ".rds")))
  newreslist <- list()
  for (i in 1:3) {
    result <- results[i]
    is_in_union <- unions[i]
    res <- reslist[[result]]
    newreslist[[i]] <- data.frame(
              name_country = reslist$core_data$units$name_country,
              division_numeric_code = reslist$core_data$units$division_numeric_code,
              is_in_union = is_in_union,
              year = res$contraceptive_use_any$year ,
              percentile = res$contraceptive_use_any$percentile,
              contraceptive_use_any = res$contraceptive_use_any$value,
              contraceptive_use_modern = res$contraceptive_use_modern$value,
              contraceptive_use_traditional = res$contraceptive_use_traditional$value,
              unmet_need_any = res$unmet_need_any$value,
              unmet_need_modern = res$unmet_need_modern$value,
              demand_satisfied_modern = res$demand_satisfied_modern$value
        )
  }
  # rbind across the list
  allreslist[[div]] <- do.call(rbind, newreslist)
}
df <- do.call(rbind, allreslist)
write.csv(df, filenamecreated)
```



